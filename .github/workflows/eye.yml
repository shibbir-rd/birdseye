name: Ping Website Every 10 Minutes

permissions:
  contents: write  # Allow push to repo using GITHUB_TOKEN

on:
  schedule:
    - cron: "*/10 * * * *"  # Every 10 minutes
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for trimming commits

      - name: Ping Website and Keep One-Day Log
        id: ping
        run: |
          DATE=$(TZ="Asia/Dhaka" date '+%Y-%m-%d %H:%M:%S %Z')
          TODAY=$(TZ="Asia/Dhaka" date '+%Y-%m-%d')

          # Ping website directly using secret, handle curl failure
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "${{ secrets.TARGET_URL }}" || echo "000")

          # Keep only today's log entries
          if [ -f status.txt ]; then
            grep "^\[$TODAY" status.txt > temp.txt || true
            mv temp.txt status.txt
          fi

          echo "[$DATE] -> $STATUS" >> status.txt
          echo "$STATUS" > last_status.txt

          # Outputs for Telegram
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "url=${{ secrets.TARGET_URL }}" >> $GITHUB_OUTPUT

      - name: Read Previous Status
        id: prev
        run: |
          if [ -f prev_status.txt ]; then
            PREV_STATUS=$(cat prev_status.txt)
          else
            PREV_STATUS="200"
          fi
          echo "prev=$PREV_STATUS" >> $GITHUB_OUTPUT

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update prev_status.txt for next run
          echo "${{ steps.ping.outputs.status }}" > prev_status.txt

          git add status.txt prev_status.txt

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update status at $(TZ='Asia/Dhaka' date '+%Y-%m-%d %H:%M:%S %Z')"
            git push
          fi

      - name: Trim Git History (Keep Last 100 Commits)
        run: |
          TOTAL=$(git rev-list --count HEAD)
          KEEP=100

          if [ "$TOTAL" -gt "$KEEP" ]; then
            OLDEST_COMMIT=$(git rev-list --max-count=$KEEP HEAD | tail -n 1)
            git checkout --orphan temp-branch $OLDEST_COMMIT
            git commit -m "Trimmed history to last $KEEP commits"
            git rebase --onto temp-branch $OLDEST_COMMIT HEAD
            git branch -D temp-branch
            git gc --prune=now --aggressive
            git push origin HEAD:main --force
          fi

      - name: Send Telegram Alert if Site Down
        if: steps.ping.outputs.status != '200'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="🚨 *Website Down Alert!*%0A📅 Time: ${{ steps.ping.outputs.date }}%0A📡 Status: ${{ steps.ping.outputs.status }}%0A🌐 URL: ${{ secrets.TARGET_URL }}" \
            -d parse_mode="Markdown"

      - name: Send Telegram Recovery Notification
        if: steps.ping.outputs.status == '200' && steps.prev.outputs.prev != '200'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="✅ *Website Recovered!*%0A📅 Time: ${{ steps.ping.outputs.date }}%0A🌐 URL: ${{ secrets.TARGET_URL }}" \
            -d parse_mode="Markdown"
